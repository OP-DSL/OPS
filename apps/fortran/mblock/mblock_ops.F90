!
! auto-generated by ops_fortran.py
!


















program MBLOCK
  use OPS_Fortran_Declarations
  use OPS_Fortran_RT_Support
  use MBLOCK_POPULATE_KERNEL_MODULE
  use OPS_CONSTANTS

  use, intrinsic :: ISO_C_BINDING

  implicit none

  type(ops_block) :: grid1, grid2

  integer S2D_00_array(2) /0,0/
  type(ops_stencil) :: S2D_00

  type(ops_dat) :: data1, data2

  integer d_p(2) /2,2/
  integer d_m(2) /-2,-2/

  integer base(2) /1,1/

  integer size(2) /20,20/


  real(8), dimension(:), allocatable :: temp

  type(ops_halo) :: h1, h2
  type(ops_halo) , DIMENSION(2) :: grp_1, grp_2, grp_3, grp_4, grp_5

  type(ops_halo_group) :: halos1, halos2, halos3, halos4, halos5

  integer halo_iter(2), base_from(2), base_to(2), dir(2), dir_to(2)




  integer iter_range(4)

  integer npartitions_l, npartitions_g
  integer d_disp(2), d_size(2)
  real(8), dimension(:,:), allocatable :: temp2



  call ops_init(2)


  call ops_decl_block(2, grid1, "grid1")
  call ops_decl_block(2, grid2, "grid2")

  call ops_decl_stencil( 2, 1, S2D_00_array, S2D_00, "00")

  call ops_decl_dat(grid1, 1, size, base, d_m, d_p, temp, data1, "real(8)", "data1")
  call ops_decl_dat(grid2, 1, size, base, d_m, d_p, temp, data2, "real(8)", "data2")



  halo_iter(1) = 2
  halo_iter(2) = 20
  base_from(1) = 19
  base_from(2) = 1
  base_to(1) = -1
  base_to(2) = 1
  dir(1) = 1
  dir(2) = 2
  call ops_decl_halo(data1, data2, halo_iter, base_from, base_to, dir, dir, h1)
  base_from(1) = 1
  base_to(1) = 21
  call ops_decl_halo(data2, data1, halo_iter, base_from, base_to, dir, dir, h2)
  grp_1(1) = h1
  grp_1(2) = h2
  call ops_decl_halo_group(2,grp_1, halos1)




  halo_iter(1) = 20
  halo_iter(2) = 2
  base_from(1) = 1
  base_from(2) = 19
  base_to(1) = 1
  base_to(2) = -1
  dir(1) = 1
  dir(2) = 2
  call ops_decl_halo(data1, data2, halo_iter, base_from, base_to, dir, dir, h1)
  base_from(2) = 1
  base_to(2) = 21
  call ops_decl_halo(data2, data1, halo_iter, base_from, base_to, dir, dir, h2)
  grp_2(1) = h1
  grp_2(2) = h2
  call ops_decl_halo_group(2,grp_2,halos2)



  halo_iter(1) = 2
  halo_iter(2) = 20
  base_from(1) = 1
  base_from(2) = 1
  base_to(1) = 21
  base_to(2) = 1
  dir(1) = 1
  dir(2) = 2
  dir_to(1) = 1
  dir_to(2) = -2
  call ops_decl_halo(data1, data2, halo_iter, base_from, base_to, dir, dir_to, h1)
  base_from(1) = 19
  base_to(1) = -1
  call ops_decl_halo(data2, data1, halo_iter, base_from, base_to, dir_to, dir,h2)
  grp_3(1) = h1
  grp_3(2) = h2
  call ops_decl_halo_group(2,grp_3,halos3)



  halo_iter(1) = 20
  halo_iter(2) = 2
  base_from(1) = 1
  base_from(2) = 1
  base_to(1) = 1
  base_to(2) = 21
  dir(1) = 1
  dir(2) = 2
  dir_to(1) = -1
  dir_to(2) = 2
  call ops_decl_halo(data1, data2, halo_iter, base_from, base_to, dir, dir_to, h1)
  base_from(2) = 19
  base_to(2) = -1
  call ops_decl_halo(data2, data1, halo_iter, base_from, base_to, dir_to, dir, h2)
  grp_4(1) = h1
  grp_4(2) = h2
  call ops_decl_halo_group(2,grp_4,halos4)



  halo_iter(1) = 2
  halo_iter(2) = 20
  base_from(1) = 19
  base_from(2) = 1
  base_to(1) = 1
  base_to(2) = -1
  dir(1) = 1
  dir(2) = 2
  dir_to(1) = 2
  dir_to(2) = 1
  call ops_decl_halo(data1, data2, halo_iter, base_from, base_to, dir, dir_to, h1)
  base_from(1) = 1
  base_to(1) = 21
  base_to(2) = 1
  call ops_decl_halo(data2, data1, halo_iter, base_from, base_to, dir_to, dir, h2)
  grp_5(1) = h1
  grp_5(2) = h2
  call ops_decl_halo_group(2,grp_5,halos5)

  call ops_partition("1D_BLOCK_DECOMPOSE")


  iter_range(1) =  1
  iter_range(2) =  20
  iter_range(3) =  1
  iter_range(4) =  20
  call mblock_populate_kernel_host("mblock_populate_kernel", grid1, 2, iter_range, &
                    & ops_arg_dat(data1, 1, S2D_00, "real(8)", OPS_WRITE), &
                    & ops_arg_idx())

  call mblock_populate_kernel_host("mblock_populate_kernel", grid2, 2, iter_range, &
                    & ops_arg_dat(data2, 1, S2D_00, "real(8)", OPS_WRITE), &
                    & ops_arg_idx())

  call ops_halo_transfer(halos1)
  call ops_halo_transfer(halos2)
  call ops_halo_transfer(halos3)
  call ops_halo_transfer(halos4)
  call ops_halo_transfer(halos5)

  call ops_print_dat_to_txtfile(data1, "data0.txt")
  call ops_print_dat_to_txtfile(data2, "data1.txt")

  npartitions_l = ops_dat_get_local_npartitions( data1 )
  npartitions_g = ops_dat_get_global_npartitions( data1 )
  print *,"npartitions l and g ", npartitions_l, npartitions_g
  call ops_dat_get_extents(data1, 1, d_disp, d_size)
  print *,"extents: ", d_disp, d_size
  allocate(temp2(d_size(1), d_size(2)))
  call ops_dat_fetch_data( data1, 1, temp2 )
  print *,temp2
  temp2(5,5) = -100
  call ops_dat_set_data( data1, 1, temp2 )
  call ops_print_dat_to_txtfile(data1, "data0_modified.txt")

  call ops_exit( )
end program MBLOCK
